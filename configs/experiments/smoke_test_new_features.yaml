# ============================================================================
# Smoke Test: 验证三项新功能（LR调度、pos_weight_clip调度、MMoE gate稳定化）
# ============================================================================
# 使用方式:
#   python -m src.cli.main train --config configs/experiments/smoke_test_new_features.yaml
# ============================================================================

experiment:
  name: smoke_test_new_features

# ===== 数据配置 =====
data:
  metadata_path: "data/processed/metadata.json"
  batch_size: 1024
  num_workers: 2
  seed: 2026
  drop_last: false
  pin_memory: true
  persistent_workers: false
  prefetch_factor: 2

# ===== 模型配置 =====
model:
  name: deepfm_mmoe_dual_sparse
  enabled_heads: [ctr, cvr]
  backbone:
    name: deepfm
    deep_mlp_dims: [128, 64]
    dropout: 0.1
  embedding:
    dim: 16
    sparse: true
  head:
    tasks: [ctr, cvr]
    mlp_dims: [64]
    dropout: 0.1
  mmoe:
    num_experts: 4
    expert_mlp_dims: [64]
    gate_type: linear
    # ============================================================
    # 改动 C: MMoE Gate 稳定化配置
    # ============================================================
    gate_stabilize:
      enabled: true
      temperature: 1.2          # >1 更平滑，避免路由锁死
      noise_std: 0.05           # gate logits 加高斯噪声（仅训练时）
      eps: 1.0e-8
      entropy_reg_weight: 1.0e-3      # 熵正则：鼓励更均匀的路由
      load_balance_kl_weight: 1.0e-3  # 负载均衡KL正则
      log_stats: true

# ===== 优化器配置 =====
optim:
  type: dual_sparse_dense
  dense:
    lr: 0.001
    weight_decay: 0.01
    betas: [0.9, 0.999]
    eps: 1.0e-8
  sparse:
    enabled: true
    lr: 0.01
    betas: [0.9, 0.999]
    eps: 1.0e-8
    allow_fallback_if_empty: true
  # ============================================================
  # 改动 A: 学习率调度配置
  # ============================================================
  lr_scheduler:
    enabled: true
    target: "dense"         # "dense" 只调度 dense optimizer | "both" 同时调度
    type: "cosine"          # "cosine" 余弦退火 | "step" 阶梯衰减
    warmup_steps: 500       # warmup 步数（smoke test 用小值）
    total_steps: 5000       # 总步数（可不填，自动推导）
    min_lr_ratio: 0.1       # cosine 最小 lr = base_lr * min_lr_ratio
    # step 方案参数（当 type="step" 时生效）
    # step_milestones: [2000, 4000]
    # step_gamma: 0.3

# ===== ESMM 配置 =====
use_esmm: true
esmm:
  version: "v2"
  lambda_ctr: 1.0
  lambda_ctcvr: 1.0
  lambda_cvr_aux: 0.0
  eps: 1.0e-8

# ===== 损失函数配置 =====
loss:
  w_ctr: 1.0
  w_cvr: 1.0
  eps: 1.0e-6
  pos_weight_dynamic: false
  static_pos_weight:
    ctr: 13.3
    ctcvr: 1000.0
  pos_weight_clip:
    ctr: 50.0
    ctcvr: 400.0    # 初始 clip 值
  # ============================================================
  # 改动 B: pos_weight_clip 调度配置
  # ============================================================
  pos_weight_clip_schedule:
    enabled: true
    target: "ctcvr"          # "ctcvr" | "ctr" | "both"
    type: "piecewise"        # "piecewise" 分段 | "linear" 线性
    # piecewise 方案：按里程碑切换
    milestones: [0, 2000]    # step 边界（smoke test 用小值）
    values: [400, 100]       # 对应的 clip 值
    # linear 方案参数（当 type="linear" 时生效）
    # start_step: 0
    # end_step: 2000
    # start_value: 400
    # end_value: 100

# ===== 采样配置 =====
sampling:
  negative_sampling: "none"

# ===== 运行时配置 =====
runtime:
  device: "cuda"
  epochs: 1
  max_train_steps: 300       # smoke test 只跑 300 步
  max_valid_steps: 50
  log_every: 50
  seed: 2026
  amp: true
  save_last: true
  grad_clip_norm: 1.0
  log_health_metrics: true
  grad_diag_enabled: false
