experiment:
  name: more_l_hetero_ple
use_esmm: true
esmm:
  version: v2
  eps: 1.0e-08
  lambda_ctr: 1.0
  lambda_ctcvr: 1.0
  lambda_cvr_aux: 0.1
data:
  metadata_path: data/processed/metadata.json
  batch_size: 1024
  num_workers: 2
  num_workers_valid: 2
  prefetch_factor: 1
  pin_memory: true
  persistent_workers: false
  drop_last: false
  debug: false
  seed: 20260127
  neg_keep_prob_train: 1.0
sampling:
  negative_sampling: none
embedding:
  default_embedding_dim: 8
  embedding_dim_overrides: {}
  mode: sum
  sparse_grad: true
model:
  name: more_ple_hetero
  mtl: ple
  enabled_heads:
  - ctr
  - cvr
  tasks:
  - ctr
  - cvr
  backbone:
    use_legacy_pseudo_deepfm: false
    return_logit_parts: true
    per_head_add:
      ctr:
        use_wide: true
        use_fm: true
      cvr:
        use_wide: false
        use_fm: false
    deep_hidden_dims:
    - 128
    - 64
    deep_dropout: 0.2
    deep_activation: relu
    deep_use_bn: false
    fm_enabled: true
    fm_projection_dim: 16
    out_dim: 64
  ple:
    hetero_enabled: true
    expert_out_dim: 128
    expert_output_align:
      layernorm: true
      learnable_scale: true
      dropout: 0.1
    experts:
      shared:
      - name: mlp_deep
        type: mlp
        dims:
        - 256
        - 128
        activation: relu
        dropout: 0.1
        use_bn: false
      - name: mlp_shallow
        type: mlp
        dims:
        - 128
        activation: relu
        dropout: 0.05
        use_bn: false
      - name: cross_v2
        type: crossnet_v2
        num_layers: 3
        low_rank: 64
        use_bias: true
        proj:
          enabled: true
          out_dim: 128
      - name: cross_v2_small
        type: crossnet_v2
        num_layers: 2
        low_rank: 32
        use_bias: true
        proj:
          enabled: true
          out_dim: 128
      private:
        ctr:
        - name: ctr_cross
          type: crossnet_v2
          num_layers: 3
          low_rank: 64
          use_bias: true
          proj:
            enabled: true
            out_dim: 128
        cvr:
        - name: cvr_mlp
          type: mlp
          dims:
          - 128
          activation: relu
          dropout: 0.05
          use_bn: false
    shared_num_experts: 4
    specific_num_experts:
      ctr: 1
      cvr: 1
    expert_mlp_dims:
    - 128
    dropout: 0.2
    activation: relu
    use_bn: false
    gate_type: linear
    gate_hidden_dims:
    - 64
    log_gates: true
    gate_stabilize:
      enabled: true
      eps: 1.0e-08
      entropy_reg_weight: 1.0e-4
      load_balance_kl_weight: 2.0e-4
      log_stats: true
      schedule:
        enabled: true
        warm_frac: 0.2
        temperature_start: 1.3
        temperature_end: 1.0
        noise_std_start: 0.05
        noise_std_end: 0.01
    gate_reg_scope: shared_only
    gate_shared_mass_floor:
      enabled: false
      per_task:
        ctr:
          min_mass: 0.5
          weight: 0.001
        cvr:
          min_mass: 0.2
          weight: 0.0005
    input: deep_h
    add_fm_vec: true
    add_emb: mean
    part_proj_dim: 128
    fusion: concat
    adapter_mlp_dims:
    - 128
    norm: layernorm
  log_gates: true
  heads:
    default:
      mlp_dims:
      - 128
      dropout: 0.1
      use_bn: false
      activation: relu
    ctr: {}
    cvr: {}
  deep_hidden_dims:  #在没有 backbone 版本时作为 fallback
  - 256
  - 128
  deep_dropout: 0.2
  deep_activation: relu
  deep_use_bn: false
  fm_enabled: true
  fm_projection_dim: 16
  out_dim: 128
optim:
  type: dual_sparse_dense
  dense:
    lr: 0.0006
    weight_decay: 1e-5
    betas:
    - 0.9
    - 0.999
    eps: 1.0e-08
  sparse:
    enabled: true
    lr: 0.001
    betas:
    - 0.9
    - 0.999
    eps: 1.0e-08
    allow_fallback_if_empty: false
  lr_scheduler:
    enabled: true
    target: both
    type: cosine
    warmup_steps: 16000
    total_steps: 100000
    min_lr_ratio: 0.1
loss:
  w_ctr: 1.0
  w_cvr: 1.0
  eps: 1.0e-06
  pos_weight_dynamic: True
  static_pos_weight:
    ctr: 10
    ctcvr: 20
  pos_weight_clip:
    ctr: 10
    ctcvr: 20
  pos_weight_clip_schedule:
    enabled: false
    target: ctcvr
    type: piecewise
    milestones:
    - 0
    - 8000
    values:
    - 300
    - 30
  aux_focal:
    enabled: false
    warmup_steps: 8000
    target_head: ctcvr
    lambda: 0.05
    gamma: 1.0
    use_alpha: false
    alpha: 0.25
    detach_p_for_weight: true
    compute_fp32: true
    log_components: true
runtime:
  device: cuda
  epochs: 3
  log_every: 3000
  amp: true
  grad_diag_enabled: true
  grad_diag_every: 1000
  grad_diag_min_tasks: 2
  log_health_metrics: true
  max_train_steps: 100000
  max_valid_steps: null
  grad_clip_norm: 2.0
  seed: 20260127
  resume_path: null
  auto_eval: true
  auto_eval_split: valid
  auto_eval_save_preds: true
  auto_eval_ckpt: best
  save_last: false
  best_selection:
    strategy: gate
    primary_key: auc_ctcvr
    aux_keys:
    - auc_ctr
    - auc_cvr
    use_primary_ma: false
    ma_window: 5
    tol_primary: 0.0001
    tol_aux:
      auc_ctr: 0.003
      auc_cvr: 0.008
    confirm_times: 1
    cooldown_evals: 0
    log_decision: true
  expert_health_diag:
    enabled: true
    log_interval: 1000
    log_on_valid: true
    utilization:
      enabled: true
      dead_threshold: 0.01
      monopoly_threshold: 0.8
      compute_gini: true
    output_stats:
      enabled: true
      per_expert_stats: true
      cross_expert_similarity: true
      similarity_alert_threshold: 0.95
    gradient:
      enabled: true
      per_expert_grad_norm: true
      vanish_threshold: 1.0e-06
      explode_threshold: 100.0
    type_specialization:
      enabled: true
      aggregate_by_type: true
      cross_task_specialization: true
    aligner:
      enabled: true
      log_scale_stats: true
      log_distribution_change: false
