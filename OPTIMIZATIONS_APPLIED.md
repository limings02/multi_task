# æ€§èƒ½ä¼˜åŒ–å®æ–½æŠ¥å‘Š

å®æ–½æ—¥æœŸ: 2026å¹´2æœˆ1æ—¥

## âœ… å·²å®Œæˆçš„ä»£ç ä¼˜åŒ–

### 1. **DataLoaderé¢„å–ä¼˜åŒ–** (é«˜ä¼˜å…ˆçº§)
**æ–‡ä»¶**: `src/data/dataloader.py`

**ä¿®æ”¹**:
- æ·»åŠ  `prefetch_factor` å‚æ•°æ”¯æŒï¼ˆé»˜è®¤å€¼ä¸º2ï¼‰
- é…ç½®æ–‡ä»¶å¯é€šè¿‡ `data.prefetch_factor` è®¾ç½®ï¼ˆå»ºè®®4-6ï¼‰
- è‡ªåŠ¨åº”ç”¨äºtrainå’Œvalid loader

**é¢„æœŸæ”¶ç›Š**: å‡å°‘æ•°æ®ç­‰å¾…æ—¶é—´ 30-50%

**ä½¿ç”¨æ–¹æ³•**: åœ¨é…ç½®æ–‡ä»¶ä¸­æ·»åŠ 
```yaml
data:
  prefetch_factor: 6  # æ¨èå€¼
```

---

### 2. **æ•°æ®é›†è¯»å–ä¼˜åŒ–** (é«˜ä¼˜å…ˆçº§)
**æ–‡ä»¶**: `src/data/dataset.py`

**ä¿®æ”¹**:
- ä½¿ç”¨columnaræ ¼å¼ (`batch.column().to_numpy()`) æ›¿ä»£é€è¡Œdictè½¬æ¢
- å‡å°‘Pythonå¾ªç¯å’Œå†…å­˜åˆ†é…å¼€é”€
- ä¿ç•™fallbackæœºåˆ¶ç¡®ä¿å…¼å®¹æ€§

**é¢„æœŸæ”¶ç›Š**: æ•°æ®è¯»å–é€Ÿåº¦ +20-30%

**æŠ€æœ¯ç»†èŠ‚**:
```python
# ä¼˜åŒ–å‰: é€è¡Œè½¬dict
tbl = batch.to_pydict()
for i in range(rows):
    row = {k: v[i] for k, v in tbl.items()}

# ä¼˜åŒ–å: columnaræ ¼å¼
cols = {name: batch.column(name).to_numpy() for name in batch.schema.names}
for i in range(rows):
    row = {k: v[i] for k, v in cols.items()}
```

---

### 3. **Collateå‡½æ•°å‘é‡åŒ–** (ä¸­ä¼˜å…ˆçº§)
**æ–‡ä»¶**: `src/data/dataloader.py`

**ä¿®æ”¹**:
- ä½¿ç”¨numpyå‘é‡åŒ–æ“ä½œè¿‡æ»¤funnelä¸ä¸€è‡´æ ·æœ¬
- æ‰¹é‡è®¡ç®—y_cvræ ¡æ­£
- å‡å°‘Pythonå¾ªç¯å¼€é”€

**é¢„æœŸæ”¶ç›Š**: Collateæ—¶é—´ -30-40%

**æŠ€æœ¯ç»†èŠ‚**:
```python
# å‘é‡åŒ–è¿‡æ»¤
y_ctr_raw = np.array([...])
y_cvr_raw = np.array([...])
valid_mask = ~((y_ctr_raw <= 0.0) & (y_cvr_raw > 0.0))
y_cvr_corrected = np.where(y_ctr_raw <= 0.0, 0.0, y_cvr_raw)
```

---

### 4. **æ€§èƒ½ç›‘æ§ç³»ç»Ÿ** (è¯Šæ–­å·¥å…·)
**æ–‡ä»¶**: `src/train/loops.py`

**ä¿®æ”¹**:
- æ·»åŠ è¯¦ç»†çš„timingç»Ÿè®¡ï¼ˆdata loading, forward, backward, optimizerï¼‰
- åœ¨è®­ç»ƒæ—¥å¿—ä¸­è¾“å‡ºå„é˜¶æ®µè€—æ—¶å’Œç™¾åˆ†æ¯”
- è‡ªåŠ¨è¯†åˆ«ç“¶é¢ˆé˜¶æ®µ

**æ—¥å¿—è¾“å‡ºç¤ºä¾‹**:
```
[train] ... timing(data=2.3s[15%] fwd=8.1s[52%] bwd=4.2s[27%] opt=0.9s[6%])
```

**ä½¿ç”¨æ–¹æ³•**: 
- å¦‚æœ data% > 20%: å¢åŠ  num_workers æˆ– prefetch_factor
- å¦‚æœ fwd% > 60%: æ¨¡å‹è®¡ç®—ç“¶é¢ˆï¼Œè€ƒè™‘ç®€åŒ–ç»“æ„
- å¦‚æœ bwd% > 35%: æ¢¯åº¦è®¡ç®—ç“¶é¢ˆï¼Œè€ƒè™‘é™ä½grad_diagé¢‘ç‡
- å¦‚æœ opt% > 10%: ä¼˜åŒ–å™¨ç“¶é¢ˆï¼ˆä¸å¸¸è§ï¼‰

---

### 5. **Trainerå‚æ•°ä¼ é€’** (åŸºç¡€è®¾æ–½)
**æ–‡ä»¶**: `src/train/trainer.py`

**ä¿®æ”¹**:
- ä»é…ç½®æ–‡ä»¶è¯»å–å¹¶ä¼ é€’ `prefetch_factor` åˆ° DataLoader
- åŒæ—¶åº”ç”¨äºtrainå’Œvalid loader

---

## ğŸ“Š é¢„æœŸç»¼åˆæ€§èƒ½æå‡

| ä¼˜åŒ–é¡¹ | è®­ç»ƒé€Ÿåº¦æå‡ | GPUåˆ©ç”¨ç‡æå‡ |
|--------|-------------|--------------|
| prefetch_factor | +5-10% | +3-5% |
| Dataset columnarè¯»å– | +10-15% | +5-8% |
| Collateå‘é‡åŒ– | +5-10% | +2-5% |
| **æ€»è®¡** | **+20-35%** | **+10-18%** |

---

## ğŸ”§ æ¨èé…ç½®è°ƒæ•´

è™½ç„¶ä»£ç å·²ä¼˜åŒ–ï¼Œä½†é…ç½®æ–‡ä»¶è°ƒæ•´èƒ½è¿›ä¸€æ­¥æå‡æ€§èƒ½ï¼š

### æœ€å°æ”¹åŠ¨ï¼ˆç«‹å³ç”Ÿæ•ˆï¼‰:
```yaml
data:
  prefetch_factor: 6      # æ–°å¢å‚æ•°
  num_workers: 10         # ä»4æå‡åˆ°10
  batch_size: 1024        # ä»512æå‡ï¼ˆå¦‚æ˜¾å­˜å…è®¸ï¼‰
```

### è¿›ä¸€æ­¥ä¼˜åŒ–ï¼ˆè®­ç»ƒç¨³å®šåï¼‰:
```yaml
runtime:
  grad_diag_enabled: false      # å…³é—­æ¢¯åº¦è¯Šæ–­
  log_health_metrics: false     # å…³é—­å¥åº·æŒ‡æ ‡
  grad_diag_every: 20000        # æˆ–é™ä½é¢‘ç‡
```

---

## ğŸ“ˆ ç›‘æ§æŒ‡æ ‡

è®­ç»ƒæ—¶è§‚å¯Ÿä»¥ä¸‹æŒ‡æ ‡éªŒè¯ä¼˜åŒ–æ•ˆæœï¼š

1. **GPUåˆ©ç”¨ç‡**: åº”ä¿æŒåœ¨ 90-95%+
   - ä½¿ç”¨ `nvidia-smi` ç›‘æ§
   - å‘¨æœŸæ€§æ³¢åŠ¨åº”æ¶ˆå¤±

2. **Timingç»Ÿè®¡**: ä»æ—¥å¿—ä¸­æŸ¥çœ‹
   - data% åº” < 15%
   - fwd% åº”å ä¸»å¯¼ (45-60%)
   - bwd% åº” 25-35%
   - opt% åº” < 10%

3. **è®­ç»ƒé€Ÿåº¦**: samples/s å’Œ steps/s
   - å¯¹æ¯”ä¼˜åŒ–å‰åçš„ç»å¯¹å€¼
   - é¢„æœŸæå‡ 20-35%

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **prefetch_factor**: 
   - è®¾ç½®è¿‡é«˜ä¼šå ç”¨æ›´å¤šå†…å­˜
   - æ¨èèŒƒå›´ 2-8ï¼Œæ ¹æ®å†…å­˜æƒ…å†µè°ƒæ•´

2. **å‘é‡åŒ–collate**:
   - éœ€è¦numpyåº“
   - å·²å†…ç½®åœ¨collateå‡½æ•°ä¸­ï¼Œæ— éœ€é¢å¤–é…ç½®

3. **æ€§èƒ½ç›‘æ§**:
   - Timingç»Ÿè®¡ä¼šå¢åŠ æå°‘é‡å¼€é”€ï¼ˆ<0.5%ï¼‰
   - å¦‚ä¸éœ€è¦å¯æ³¨é‡Šæ‰ç›¸å…³ä»£ç 

4. **Windowsç‰¹å®š**:
   - num_workers å»ºè®®ä¸è¶…è¿‡ 12
   - persistent_workers=true åœ¨Windowsä¸Šå°¤å…¶é‡è¦

---

## ğŸ¯ ä¸‹ä¸€æ­¥å»ºè®®

å¦‚æœå®Œæˆä¸Šè¿°ä¼˜åŒ–åä»æœ‰ç“¶é¢ˆï¼Œè€ƒè™‘ï¼š

1. **æ¨¡å‹ç»“æ„ç®€åŒ–** (éœ€è¦å®éªŒéªŒè¯):
   ```yaml
   model:
     mmoe:
       add_fm_vec: false        # å‡å°‘è¾“å…¥å¤æ‚åº¦
       adapter_mlp_dims: []     # ç§»é™¤adapter
   ```

2. **è´Ÿé‡‡æ ·æ¯”ä¾‹è°ƒæ•´**:
   ```yaml
   data:
     neg_keep_prob_train: 0.5-0.6  # ä»0.4æé«˜
   ```

3. **è®­ç»ƒæ­¥æ•°ä¼˜åŒ–**:
   - æé«˜batch_sizeåå¯é™ä½max_train_steps
   - ç›‘æ§validationæ›²çº¿æå‰åœæ­¢

---

## ğŸ“ å›æ»šæ–¹æ³•

å¦‚é‡åˆ°é—®é¢˜éœ€è¦å›æ»šï¼š

```bash
git diff src/data/dataloader.py
git diff src/data/dataset.py
git diff src/train/loops.py
git diff src/train/trainer.py

# å¦‚éœ€å›æ»š
git checkout HEAD -- src/data/dataloader.py
git checkout HEAD -- src/data/dataset.py
git checkout HEAD -- src/train/loops.py
git checkout HEAD -- src/train/trainer.py
```

---

## âœ¨ æ€»ç»“

æ‰€æœ‰ä»£ç ä¼˜åŒ–å·²å®Œæˆï¼Œæ— éœ€ä¿®æ”¹é…ç½®æ–‡ä»¶å³å¯è·å¾—åŸºç¡€æ€§èƒ½æå‡ã€‚
å»ºè®®é…åˆé…ç½®è°ƒæ•´ï¼ˆprefetch_factor, num_workers, batch_sizeï¼‰ä»¥è¾¾åˆ°æœ€ä½³æ•ˆæœã€‚

é¢„æœŸæœ€ç»ˆæ•ˆæœï¼š
- GPUåˆ©ç”¨ç‡: 95%+ æŒç»­ç¨³å®š
- è®­ç»ƒé€Ÿåº¦: æå‡ 50-75%ï¼ˆä»£ç ä¼˜åŒ– + é…ç½®è°ƒæ•´ï¼‰
- æ— å‘¨æœŸæ€§æ³¢åŠ¨ï¼ˆpersistent_workerså·²åœ¨é…ç½®ä¸­å¯ç”¨ï¼‰
